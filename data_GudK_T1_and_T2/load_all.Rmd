---
title: "Load and fix csv data files"
output:
  html_document:
    df_print: "paged"
---

```{r, message = FALSE}
library(dplyr)
library(purrr)
library(readr)
library(tidyr)
```

First we get a list of all the subject CSV data files in the current directory.

```{r}
filenames <- list.files(pattern = "[A-Z0-9]+.csv")

filenames
```

Then read them all into one data frame. In doing so we need to take into account the `--` character sequence that Psychopy uses for missing values.

```{r, message = FALSE}
d <- map_df(filenames, ~read_csv(., na = "--"))

d
```

Subjects have been allocated a different ID for each of their two sessions, with suffixes *1* and *2*. So let's split the IDs into two separate columns, for the base ID and the session suffix.

```{r}
d %>%
  separate(subject, c("subject", "session"), sep = -1) ->
  d

head(d)
```

Some trials were generated, but not run. We should throw these out.

```{r}
d %>%
  filter(ran == 1) ->
  d
```

Now we can count how many completed trials we have per subject.

```{r}
d %>%
  count(subject)
```

There are mistypings of `AN32MA`, `HA28TH`, `HE30DI`, and `TA36CE`, which we should recode.

```{r}
d %>%
  mutate(subject = recode(
    subject,
    AN32AN32MA = "AN32MA",
    AN32MAAN32MA = "AN32MA",
    HA28TH2HA28TH = "HA28TH",
    HE30DI2HE30DI = "HE30DI",
    TA36CEN = "TA36CE"
  )) ->
  d

d %>%
  count(subject)
```

There are still a few anomalies, but these might not necessarily be errors:

* `MA10OL` and `SO13CH` only completed three quarters as many trials as the others.
* `RA28HU` and `SA30RO` only completed half as many.
* `TA36CE` completed an additional 32 trials.

If we need to we can export the wrangled data to a new CSV file.

```{r}
write_csv(d, "GudK_T1_and_T2_fixed.csv")
```
