---
title: "Order analysis"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    df_print: "paged"
---

```{r, message=FALSE}
library(dplyr)
library(ggplot2)
library(lme4)
```

Accounting for the order of conditions in Natasha's experiment.

## Data

Let's get the example data file from the `data` directory. While we're at it, we can convert the Reaction Times to milliseconds.

```{r}
d = read.csv("data/cleanAHData.csv") %>%
  mutate(RT=RT*1000)

d
```

There are some superfluous initial columns as a result of row names having been saved more than once, but this doesn't matter.

Unfortunately the `order` column does not track the order of the two condition blocks. It tracks instead the order of individual trials. The lack of a 'block order' column is my fault. I should have put this into the output data file when writing the [experiment script](gsf.py).

### Order variable

So let's create a new column to record the order of condition blocks and redeem my earlier mistake. We can create two new columns for two different ways of thinking about the order of condition blocks:

* `condition_order`: A between-subjects variable that tracks which condition the subject completed first (`G` or `S`).
* `block`: A within-subjects variable that tracks the order of the two blocks for each half of each subject's data (`1` or `2`).

```{r}
get_condition_order = function(condition){
  return(condition[1])
}

get_block_number = function(condition, condition_order){
  is_first_block = condition == condition_order
  return(2 - is_first_block)
}

d = d %>%
  group_by(subject) %>%
  mutate(condition_order=get_condition_order(condition), block=get_block_number(condition, condition_order)) %>%
  ungroup() %>%
  mutate(condition_order=factor(condition_order), block=factor(block))

d
```

## Plot

Does RT appear to vary consistently with the order of conditions?

```{r}
group_width = 0.2

fig = ggplot(d, aes(x=factor(block), y=RT, fill=condition)) +
  labs(x="block", y="RT (ms)") +
  geom_jitter(shape="circle filled", height=0, width=group_width) +
  facet_wrap(vars(subject))

fig
```

Of course, we don't really get any strong conclusions from these data, since we have only four subjects and they are in fact the same person repeatedly testing out the experiment. Here the variance in RT between conditions is rather dominated by the very first block that the person did (`A01` block `1`), in which they were quite a bit slower. It seems as though RTs are generally a bit slower in the first block of each session as well.

## Linear model

Just as an example, let's see how we might incorporate the `block` variable into a linear mixed effects model.

Let's try out a few models:

* `m0`: A 'null' model with no effects of order or of condition.
* `m_order`: A model of order effects only.
* `m_condition`: A model of the effect of condition while accounting also for order.
* `m_interaction`: A model of the effect of condition dependent on order.

```{r}
m0 = lmer(RT ~ 1 + (1|subject), d, REML=FALSE)
m_order = update(m0, ~ . + block)
m_condition = update(m_order, ~ . + condition)
m_interaction = update(m_condition, ~ . + condition:block)
```

As a check, let's look at the full summary of the most complex model, `m_interaction`.

```{r}
summary(m_interaction)
```

The Standard Errors of the estimates are fairly high (a few hundred milliseconds), so we haven't estimated the model so precisely. This is to be expected given that we have only four subjects. But otherwise everything looks ok.

Let's also add the model's predicted values to our earlier plot (with a naughty `geom_boxplot()` hack), as a visual check that it has fit the data correctly.

```{r}
d[,"predicted"] = predict(m_interaction)

fig %+% d +
  geom_boxplot(aes(y=predicted), show.legend=FALSE)
```

Looks reasonable. Now we can compare the models.

```{r}
anova(m0, m_order, m_condition, m_interaction)
```

Applying a few quick rule-of-thumb model comparison criteria, the tentative conclusions here would be:

* Subjects tend to be faster in the second block:
  * All criteria (AIC, BIC, and likelihood ratio test) favor `m_order` over the null model.
  * The estimate for `block2` in the full model is negative.
* Subjects tend to be faster in condition S:
  * All criteria favor `m_condition` over `m_order`, i.e. an effect of condition in addition to the effect of order.
  * The estimate for `conditionS` in the full model is negative.
* Perhaps the effect of condition depends on the order in which they are presented:
  * AIC weakly favors `m_interaction` over `m_order`.

But as we noted earlier, in these data the conclusions are somewhat dominated by the fact that the subject was slowest in the very first block of the first session, and this happened to be a condition G session.
